# coding: utf-8
import sys, os

# sys.path.append(os.pardir)  # 将父目录添加到系统路径中，以便导入父目录中的模块

ROOT_DIR = os.path.abspath(os.path.join(os.path.dirname(__file__), ".."))
print(f"ROOT_DIR = ", ROOT_DIR)  # /root/private/fishbook/deep-learning-from-scratch
sys.path.append(ROOT_DIR)

import numpy as np
import matplotlib.pyplot as plt
from dataset.mnist import load_mnist
from two_layer_net import TwoLayerNet

import math

# 使用 load_mnist() 函数加载 MNIST 数据集，并进行归一化处理和 One-hot 编码
(train_img, train_label), (test_img, test_label) = load_mnist(
    normalize=True, one_hot_label=True
)

# 打印训练数据的形状
print(f"train_img.shape = ", train_img.shape)  # (60000, 784) , 即 60000 张 28x28 的图像
print(
    f"train_label.shape = ", train_label.shape
)  # (60000, 10) ，每个样本对应一个 10 维的 one-hot 标签
print(f"test_img.shape = ", test_img.shape)  # test_img.shape =  (10000, 784)
print(f"test_label.shape = ", test_label.shape)  # test_label.shape =  (10000, 10)

# NOTE 创建一个两层神经网络实例
# 输入层大小为 784，隐藏层大小为 50，输出层大小为 10（数字类别数）
network = TwoLayerNet(input_size=784, hidden_size=50, output_size=10)
print(f"network: \n", network)
# <two_layer_net.TwoLayerNet object at 0x7f39ba03bdf0>
print(f"network.params.keys(): \n", network.params.keys())
# dict_keys(['W1', 'b1', 'W2', 'b2'])

# 设置训练用的超参数
iters_num = 10000  # 梯度下降的总迭代次数，已知 1 个 Epoch 需要 600 次迭代，那么10000次迭代相当于 16.6个 Epoch
train_size = train_img.shape[0]  # 取出第一维度：训练数据总数 (60000)
batch_size = 100  # 每次训练使用的样本数量（批量大小）
learning_rate = 0.1  # 学习率

# 初始化记录训练过程的列表
train_loss_list = []  # 每次迭代的损失值
train_acc_list = []  # 每个 epoch 的训练准确率
test_acc_list = []  # 每个 epoch 的测试准确率

# 计算每个 epoch 需要的迭代次数，处理 100 张图片（一个 batch_size） = 1 次迭代 = 网络权重更新 1 次
# epoch 含义：所有训练数据均被遍历一次的迭代总数。此处为 60000 / 100 = 600 次。
iter_per_epoch = max(train_size / batch_size, 1)
print(f"iter_per_epoch = ", iter_per_epoch)  # iter_per_epoch =  600.0

print("Train beginning ...")

# 开始训练循环
for i in range(iters_num):
    batch_mask = np.random.choice(train_size, batch_size)  # 随机选择一个批次(100个)数据
    # print(f"batch_mask.shape = ", batch_mask.shape)  # batch_mask.shape =  (100,)
    # print(f"batch_mask: \n", batch_mask)  # 打印这 100 个随机数据，如 [233 3818 ... 20645]
    x_batch_train = train_img[batch_mask]
    # print(f"x_batch_train.shape = ", x_batch_train.shape)  # x_batch_train.shape =  (100, 784)
    t_batch_label = train_label[batch_mask]
    # print(f"t_batch_label.shape = ", t_batch_label.shape)  # t_batch_label.shape =  (100, 10)

    # 计算梯度
    # grad = network.numerical_gradient(x_batch_train, t_batch_label)  # 数值微分法计算梯度（较慢）
    grad = network.gradient(
        x_batch_train, t_batch_label
    )  # 反向传播法计算梯度（较快！）
    # print(f"grad = ", grad)
    # grad = {
    #     "W2": array(
    #         [
    #             [
    #                 -3.02591404e-04,
    #                 1.68036124e-03,
    #                 1.92047490e-04,
    #                 -9.28796297e-04,
    #                 2.19761318e-04,
    #                 -8.03303253e-04,
    #                 1.16255410e-03,
    #                 4.12926815e-03,
    #                 -1.18224391e-05,
    #                 -5.33747890e-03,
    #             ],
    #             [
    #                 3.19121812e-03,
    #                 3.20755481e-03,
    #                 4.91387930e-03,
    #                 -1.11577995e-02,
    #                 9.33311254e-05,
    #                 -1.28623014e-02,
    #                 6.59261287e-03,
    #                 7.27906352e-04,
    #                 4.56815430e-03,
    #                 7.25443990e-04,
    #             ],
    #             [
    #                 2.94223563e-03,
    #                 2.30848983e-03,
    #                 6.36363942e-03,
    #                 -1.60065684e-03,
    #                 4.31178900e-04,
    #                 -1.77934400e-02,
    #                 6.33702905e-03,
    #                 -2.65042792e-03,
    #                 1.28474528e-03,
    #                 2.37720667e-03,
    #             ],
    #             [
    #                 2.13293770e-03,
    #                 4.89379972e-04,
    #                 1.32759974e-03,
    #                 7.75059923e-04,
    #                 7.73427803e-04,
    #                 -1.03120242e-02,
    #                 2.05038224e-03,
    #                 2.00982053e-03,
    #                 4.26398899e-03,
    #                 -3.51057271e-03,
    #             ],
    #             [
    #                 2.70132022e-03,
    #                 1.16742258e-03,
    #                 5.84104319e-03,
    #                 -4.74799147e-03,
    #                 -4.79088021e-03,
    #                 -1.67902923e-02,
    #                 6.85856187e-03,
    #                 2.96388287e-03,
    #                 3.16284077e-03,
    #                 3.63409243e-03,
    #             ],
    #             [
    #                 1.60436108e-03,
    #                 2.14239203e-03,
    #                 2.44279615e-03,
    #                 -7.06862325e-03,
    #                 -2.99783542e-03,
    #                 -3.49377485e-03,
    #                 7.09910545e-03,
    #                 -2.88978362e-03,
    #                 2.58663262e-03,
    #                 5.74729825e-04,
    #             ],
    #             [
    #                 1.21803222e-03,
    #                 2.27417632e-04,
    #                 1.75940529e-03,
    #                 2.51130891e-03,
    #                 3.55359076e-04,
    #                 -1.06733395e-02,
    #                 4.51570326e-03,
    #                 3.35987372e-04,
    #                 2.59659053e-03,
    #                 -2.84646477e-03,
    #             ],
    #             [
    #                 3.13018670e-03,
    #                 2.87660009e-03,
    #                 5.55037661e-03,
    #                 -2.55344613e-04,
    #                 3.35768842e-03,
    #                 -1.83185377e-02,
    #                 6.08425428e-03,
    #                 1.53673472e-04,
    #                 1.60083259e-03,
    #                 -4.17972981e-03,
    #             ],
    #             [
    #                 4.45456456e-03,
    #                 2.77217234e-03,
    #                 7.73529280e-03,
    #                 -8.59372605e-03,
    #                 -3.57548991e-03,
    #                 -2.25378852e-02,
    #                 8.68743661e-03,
    #                 2.99299838e-03,
    #                 4.38758757e-03,
    #                 3.67704893e-03,
    #             ],
    #             [
    #                 2.43861314e-03,
    #                 2.12768982e-03,
    #                 3.75916107e-03,
    #                 -2.55833621e-03,
    #                 7.36665868e-04,
    #                 -7.23682369e-03,
    #                 4.27667085e-03,
    #                 -2.60296012e-03,
    #                 7.16329635e-05,
    #                 -1.01231369e-03,
    #             ],
    #             [
    #                 1.30345513e-03,
    #                 6.75206984e-04,
    #                 4.09486013e-03,
    #                 3.09250919e-03,
    #                 -2.05345898e-03,
    #                 -7.38392789e-03,
    #                 2.49371057e-03,
    #                 -3.58577767e-03,
    #                 -2.61619643e-04,
    #                 1.62504218e-03,
    #             ],
    #             [
    #                 8.88534953e-05,
    #                 3.01849668e-03,
    #                 3.16424852e-03,
    #                 -9.56850196e-03,
    #                 2.65252973e-04,
    #                 -4.37027099e-03,
    #                 6.55767886e-03,
    #                 -4.96562685e-03,
    #                 3.54552500e-03,
    #                 2.26434428e-03,
    #             ],
    #             [
    #                 3.73157199e-03,
    #                 4.10099335e-03,
    #                 5.81796233e-03,
    #                 -8.23570181e-03,
    #                 3.34558954e-03,
    #                 -1.94032644e-02,
    #                 7.65596796e-03,
    #                 -1.78223916e-03,
    #                 3.84708085e-03,
    #                 9.22039358e-04,
    #             ],
    #             [
    #                 3.46644381e-03,
    #                 3.53054925e-03,
    #                 5.73078457e-03,
    #                 -9.40980773e-03,
    #                 -1.21026393e-03,
    #                 -1.76987281e-02,
    #                 7.71521245e-03,
    #                 -4.19446091e-04,
    #                 4.99121952e-03,
    #                 3.30403622e-03,
    #             ],
    #             [
    #                 4.44081332e-03,
    #                 1.19592515e-03,
    #                 7.14374405e-03,
    #                 2.03176914e-03,
    #                 -3.72741583e-04,
    #                 -2.38209754e-02,
    #                 7.98579752e-03,
    #                 5.81808745e-03,
    #                 2.53428706e-04,
    #                 -4.67584832e-03,
    #             ],
    #             [
    #                 1.55513395e-03,
    #                 9.57800752e-04,
    #                 4.48539981e-03,
    #                 -4.40343529e-04,
    #                 -2.75195106e-03,
    #                 -8.36881783e-03,
    #                 4.32776860e-03,
    #                 -2.94422602e-03,
    #                 -4.97939310e-04,
    #                 3.67717466e-03,
    #             ],
    #             [
    #                 2.04827691e-03,
    #                 1.85086923e-03,
    #                 4.73671065e-03,
    #                 -5.35680917e-03,
    #                 -3.26434676e-03,
    #                 -1.28726209e-02,
    #                 6.16897700e-03,
    #                 2.50908113e-03,
    #                 1.92620343e-03,
    #                 2.25365851e-03,
    #             ],
    #             [
    #                 4.23335281e-03,
    #                 2.07274979e-03,
    #                 6.22826816e-03,
    #                 -5.31432909e-03,
    #                 1.16372824e-03,
    #                 -1.74876597e-02,
    #                 4.46823779e-03,
    #                 5.82610324e-03,
    #                 3.16276110e-03,
    #                 -4.35321238e-03,
    #             ],
    #             [
    #                 1.62257434e-03,
    #                 1.52042989e-03,
    #                 2.10831233e-03,
    #                 -7.53188622e-05,
    #                 2.30073630e-03,
    #                 -2.15359884e-03,
    #                 1.63476387e-03,
    #                 -2.14924877e-04,
    #                 1.78173515e-03,
    #                 -8.52470931e-03,
    #             ],
    #             [
    #                 4.11109431e-03,
    #                 2.93138060e-03,
    #                 7.28523938e-03,
    #                 -5.62902781e-03,
    #                 3.09275623e-04,
    #                 -2.09032509e-02,
    #                 7.23024669e-03,
    #                 4.80389453e-03,
    #                 3.50719824e-03,
    #                 -3.64605067e-03,
    #             ],
    #             [
    #                 4.07886897e-03,
    #                 1.99558542e-03,
    #                 7.71570417e-03,
    #                 -4.46868814e-03,
    #                 -5.07281221e-04,
    #                 -2.12215394e-02,
    #                 7.02507164e-03,
    #                 5.36880417e-04,
    #                 4.06797605e-03,
    #                 7.77422054e-04,
    #             ],
    #             [
    #                 4.69001320e-03,
    #                 1.11884547e-03,
    #                 6.52978941e-03,
    #                 -4.43299299e-04,
    #                 -2.00896417e-04,
    #                 -2.21661329e-02,
    #                 6.78900981e-03,
    #                 5.73158222e-03,
    #                 1.70183887e-03,
    #                 -3.75075040e-03,
    #             ],
    #             [
    #                 4.05013772e-03,
    #                 1.97197819e-03,
    #                 7.57163828e-03,
    #                 7.32728841e-05,
    #                 -5.81502434e-04,
    #                 -2.49189962e-02,
    #                 7.82367032e-03,
    #                 2.56212699e-03,
    #                 3.51593427e-03,
    #                 -2.06826002e-03,
    #             ],
    #             [
    #                 1.73051862e-03,
    #                 6.33259749e-04,
    #                 4.46065139e-03,
    #                 1.78894112e-03,
    #                 -1.14512444e-03,
    #                 -7.92145322e-03,
    #                 2.99513146e-03,
    #                 1.76023744e-03,
    #                 9.77283209e-04,
    #                 -5.27944533e-03,
    #             ],
    #             [
    #                 4.12446692e-04,
    #                 1.98251288e-03,
    #                 1.11789741e-05,
    #                 -2.47374501e-03,
    #                 -2.74609522e-04,
    #                 -4.11605612e-03,
    #                 4.24986550e-03,
    #                 -4.38700014e-04,
    #                 9.28582400e-04,
    #                 -2.81475785e-04,
    #             ],
    #             [
    #                 5.58708382e-04,
    #                 1.79386539e-03,
    #                 2.93239036e-03,
    #                 -5.31600128e-03,
    #                 -2.25933924e-03,
    #                 -7.82675317e-03,
    #                 5.97350051e-03,
    #                 -9.41463932e-04,
    #                 3.17326180e-03,
    #                 1.91183116e-03,
    #             ],
    #             [
    #                 7.65499494e-04,
    #                 2.73577873e-03,
    #                 2.18586951e-03,
    #                 -1.74185718e-03,
    #                 1.78463875e-03,
    #                 -9.62969895e-03,
    #                 5.63564505e-03,
    #                 -1.32360916e-03,
    #                 2.09247825e-03,
    #                 -2.50474449e-03,
    #             ],
    #             [
    #                 1.06839253e-03,
    #                 2.03504510e-03,
    #                 1.18453801e-03,
    #                 7.25426294e-04,
    #                 4.20784746e-03,
    #                 -2.87231089e-03,
    #                 5.93851802e-04,
    #                 -3.75923564e-03,
    #                 2.24409685e-03,
    #                 -5.42765152e-03,
    #             ],
    #             [
    #                 2.67726408e-04,
    #                 2.85647178e-03,
    #                 1.88958268e-03,
    #                 -6.57519091e-03,
    #                 4.33913581e-04,
    #                 -1.75092764e-03,
    #                 1.69417394e-03,
    #                 -6.39852588e-03,
    #                 3.89267721e-03,
    #                 3.69009883e-03,
    #             ],
    #             [
    #                 6.16510182e-04,
    #                 2.79105068e-03,
    #                 1.82593886e-03,
    #                 -2.23951751e-03,
    #                 2.18140606e-03,
    #                 -3.29351352e-03,
    #                 4.31412241e-03,
    #                 -3.38836159e-03,
    #                 -2.84247690e-04,
    #                 -2.52338788e-03,
    #             ],
    #             [
    #                 1.71648677e-03,
    #                 1.04772645e-03,
    #                 5.51631111e-03,
    #                 4.80631126e-04,
    #                 -9.50606609e-04,
    #                 -8.02041548e-03,
    #                 2.72569616e-03,
    #                 6.15734918e-04,
    #                 -5.04545185e-04,
    #                 -2.62701926e-03,
    #             ],
    #             [
    #                 1.22110369e-03,
    #                 8.40787576e-04,
    #                 8.95891806e-04,
    #                 -2.59959586e-03,
    #                 7.77783040e-04,
    #                 -2.14065921e-03,
    #                 7.51702296e-04,
    #                 -1.58454003e-04,
    #                 8.04839450e-04,
    #                 -3.93398791e-04,
    #             ],
    #             [
    #                 2.53648279e-03,
    #                 4.95522081e-04,
    #                 4.69149186e-03,
    #                 2.49555632e-03,
    #                 -5.28750803e-04,
    #                 -1.40727222e-02,
    #                 3.57500185e-03,
    #                 2.26258530e-03,
    #                 1.73721400e-03,
    #                 -3.19238126e-03,
    #             ],
    #             [
    #                 4.52916642e-03,
    #                 2.01268452e-03,
    #                 8.29197612e-03,
    #                 -8.36061447e-03,
    #                 -2.29110274e-03,
    #                 -1.94991638e-02,
    #                 5.77414898e-03,
    #                 2.30419691e-03,
    #                 6.78644289e-03,
    #                 4.52265135e-04,
    #             ],
    #             [
    #                 8.62287172e-04,
    #                 2.22580221e-03,
    #                 4.58592603e-03,
    #                 -7.20763790e-03,
    #                 -3.21422900e-03,
    #                 -1.18862065e-02,
    #                 7.55839667e-03,
    #                 2.58009606e-03,
    #                 2.48513609e-03,
    #                 2.01042916e-03,
    #             ],
    #             [
    #                 2.10640160e-03,
    #                 4.45059651e-04,
    #                 4.58604880e-03,
    #                 8.31130294e-04,
    #                 -4.18464979e-03,
    #                 -7.55071534e-03,
    #                 3.14514199e-03,
    #                 5.06919825e-03,
    #                 -7.56688944e-04,
    #                 -3.69092651e-03,
    #             ],
    #             [
    #                 2.40627291e-03,
    #                 1.98717142e-03,
    #                 3.41396556e-03,
    #                 -3.08824682e-03,
    #                 -1.20804483e-03,
    #                 -1.06313281e-02,
    #                 6.31331160e-03,
    #                 -7.75455918e-04,
    #                 1.85637367e-04,
    #                 1.39671682e-03,
    #             ],
    #             [
    #                 1.34341706e-03,
    #                 4.47788959e-04,
    #                 1.47897688e-03,
    #                 -1.47997890e-04,
    #                 7.13884856e-04,
    #                 -7.15593386e-03,
    #                 2.87262127e-03,
    #                 2.11957201e-03,
    #                 1.93938058e-03,
    #                 -3.61170986e-03,
    #             ],
    #             [
    #                 2.69572213e-03,
    #                 3.19645019e-03,
    #                 5.24593190e-03,
    #                 -9.72570650e-03,
    #                 -4.86949742e-04,
    #                 -1.20285673e-02,
    #                 3.70020844e-03,
    #                 3.76296760e-03,
    #                 1.91509229e-03,
    #                 1.72485098e-03,
    #             ],
    #             [
    #                 1.24585312e-03,
    #                 1.99533690e-03,
    #                 2.74538591e-03,
    #                 -3.25729054e-03,
    #                 1.21577967e-03,
    #                 -1.07992057e-02,
    #                 6.41304648e-03,
    #                 -8.92562017e-04,
    #                 3.59123332e-03,
    #                 -2.25757714e-03,
    #             ],
    #             [
    #                 1.86277035e-03,
    #                 2.52203137e-03,
    #                 1.41001699e-03,
    #                 -3.83422867e-03,
    #                 5.41659028e-04,
    #                 -6.27113019e-03,
    #                 2.07825267e-03,
    #                 2.96569945e-03,
    #                 2.42590545e-03,
    #                 -3.70097646e-03,
    #             ],
    #             [
    #                 5.53903908e-04,
    #                 7.42707294e-04,
    #                 2.32999980e-03,
    #                 2.07158053e-03,
    #                 1.58283563e-04,
    #                 -8.87748271e-03,
    #                 4.15397023e-03,
    #                 -4.43071779e-03,
    #                 9.67902054e-05,
    #                 3.20096497e-03,
    #             ],
    #             [
    #                 1.43657988e-03,
    #                 2.23974342e-03,
    #                 2.85298874e-03,
    #                 -4.67720570e-03,
    #                 -7.86222302e-04,
    #                 -5.46684559e-03,
    #                 2.25082164e-03,
    #                 4.33911524e-03,
    #                 3.80190679e-03,
    #                 -5.99088213e-03,
    #             ],
    #             [
    #                 2.32114826e-03,
    #                 1.71899931e-03,
    #                 3.92173174e-03,
    #                 -4.89176073e-03,
    #                 3.76241882e-04,
    #                 -1.83800887e-02,
    #                 6.22341238e-03,
    #                 5.61793069e-04,
    #                 3.47893646e-03,
    #                 4.66958633e-03,
    #             ],
    #             [
    #                 1.77538120e-03,
    #                 2.27299828e-03,
    #                 3.38423604e-03,
    #                 -4.55500718e-03,
    #                 2.56053212e-03,
    #                 -3.90818741e-03,
    #                 3.26600806e-03,
    #                 -7.26074992e-04,
    #                 2.69918757e-03,
    #                 -6.76907370e-03,
    #             ],
    #             [
    #                 1.14590636e-03,
    #                 2.57307628e-03,
    #                 3.45264111e-03,
    #                 -2.36154806e-03,
    #                 3.59298212e-03,
    #                 -9.16615288e-03,
    #                 2.33002591e-03,
    #                 2.08429685e-03,
    #                 7.79912147e-04,
    #                 -4.43113984e-03,
    #             ],
    #             [
    #                 1.12964776e-03,
    #                 2.12060742e-03,
    #                 1.75470998e-03,
    #                 -5.02454152e-03,
    #                 2.45685129e-03,
    #                 -4.99300370e-03,
    #                 4.91840430e-03,
    #                 -1.36068065e-03,
    #                 1.29795570e-03,
    #                 -2.29995057e-03,
    #             ],
    #             [
    #                 4.22078883e-03,
    #                 1.99791889e-03,
    #                 5.78153923e-03,
    #                 -5.30372743e-04,
    #                 1.64633912e-04,
    #                 -1.36180792e-02,
    #                 2.69987185e-03,
    #                 1.32303831e-03,
    #                 2.62599821e-03,
    #                 -4.66533727e-03,
    #             ],
    #             [
    #                 8.09292474e-04,
    #                 2.73058374e-03,
    #                 3.08738283e-03,
    #                 -1.90229931e-03,
    #                 4.15026219e-04,
    #                 -9.57561550e-03,
    #                 5.74197348e-03,
    #                 -2.42751300e-03,
    #                 2.27690681e-03,
    #                 -1.15573775e-03,
    #             ],
    #             [
    #                 2.49309426e-03,
    #                 3.94730075e-03,
    #                 6.25668112e-03,
    #                 -1.04284152e-02,
    #                 -6.81247159e-05,
    #                 -3.25731661e-03,
    #                 3.93118169e-03,
    #                 -7.94962734e-04,
    #                 1.29516804e-03,
    #                 -3.37460660e-03,
    #             ],
    #         ]
    #     ),
    #     "b2": array(
    #         [
    #             4.75256617e-03,
    #             4.13407816e-03,
    #             8.63340043e-03,
    #             -8.23261109e-03,
    #             1.25460721e-05,
    #             -2.25158132e-02,
    #             9.27117309e-03,
    #             1.37190791e-03,
    #             5.14526757e-03,
    #             -2.57251510e-03,
    #         ]
    #     ),
    #     "W1": array(
    #         [
    #             [0.0, 0.0, 0.0, ..., 0.0, 0.0, 0.0],
    #             [0.0, 0.0, 0.0, ..., 0.0, 0.0, 0.0],
    #             [0.0, 0.0, 0.0, ..., 0.0, 0.0, 0.0],
    #             ...,
    #             [0.0, 0.0, 0.0, ..., 0.0, 0.0, 0.0],
    #             [0.0, 0.0, 0.0, ..., 0.0, 0.0, 0.0],
    #             [0.0, 0.0, 0.0, ..., 0.0, 0.0, 0.0],
    #         ],
    #         shape=(784, 50),
    #     ),
    #     "b1": array(
    #         [
    #             0.00672237,
    #             0.00095259,
    #             -0.00116602,
    #             -0.00649293,
    #             0.00459732,
    #             0.00097653,
    #             -0.00900972,
    #             -0.00449281,
    #             0.00152506,
    #             0.00129778,
    #             0.00196454,
    #             0.00347389,
    #             -0.00434883,
    #             0.00095782,
    #             0.00161871,
    #             0.00508116,
    #             0.0026564,
    #             -0.00030045,
    #             -0.00055056,
    #             -0.00188862,
    #             -0.00181891,
    #             -0.00240982,
    #             -0.00203879,
    #             0.00160279,
    #             -0.00175507,
    #             0.00203324,
    #             -0.00397826,
    #             -0.00393805,
    #             -0.00301663,
    #             0.00071135,
    #             -0.00225752,
    #             0.00357225,
    #             0.00134128,
    #             -0.00445035,
    #             0.00631149,
    #             0.00553616,
    #             0.00182376,
    #             -0.00398091,
    #             -0.00062893,
    #             -0.00027832,
    #             0.0007589,
    #             0.00440979,
    #             0.00089343,
    #             0.00125004,
    #             -0.00818935,
    #             0.0063013,
    #             0.00241654,
    #             -0.00243102,
    #             -0.00185546,
    #             0.00648305,
    #         ]
    #     ),
    # }

    # print(f"grad.keys() = ", grad.keys())
    # grad.keys() =  dict_keys(['W2', 'b2', 'W1', 'b1'])

    # 更新网络参数（权重和偏置）
    for key in ("W1", "b1", "W2", "b2"):
        network.params[key] -= learning_rate * grad[key]

    # note 计算并记录当前批次的损失
    loss = network.loss(x_batch_train, t_batch_label)
    train_loss_list.append(loss)

    # 每完成一个 epoch（600 次迭代）时，计算训练集和测试集的准确率
    if i % iter_per_epoch == 0:
        print(
            f"Epoch {int(i / iter_per_epoch) + 1}/{math.ceil(iters_num / iter_per_epoch)}"
        )

        train_acc = network.accuracy(train_img, train_label)
        test_acc = network.accuracy(test_img, test_label)
        train_acc_list.append(train_acc)
        test_acc_list.append(test_acc)

        print("train acc, test acc | " + str(train_acc) + ", " + str(test_acc))
        # train acc, test acc | 0.0993, 0.1032

print("Train finished ...")

# 绘制训练结果图表
markers = {"train": "o", "test": "s"}  # 设置训练集和测试集的标记样式
x = np.arange(len(train_acc_list))  # x 轴为 epoch 数

plt.plot(x, train_acc_list, label="train acc")  # 绘制训练准确率曲线
plt.plot(x, test_acc_list, label="test acc", linestyle="--")  # 绘制测试准确率曲线
plt.xlabel("epochs")  # x轴标签
plt.ylabel("accuracy")  # y轴标签
plt.ylim(0, 1.0)  # y轴范围设置为0到1
plt.legend(loc="lower right")  # 设置了 label 后，必须调用 plt.legend() 才会显示图例

# 保存到本地
plt.savefig("ch04/train_neuralnet.png")

# plt.show()  # 显示图表(服务器模式下无法显示图像)
